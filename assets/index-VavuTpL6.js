var j=Object.defineProperty;var R=(e,n,t)=>n in e?j(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;var b=(e,n,t)=>R(e,typeof n!="symbol"?n+"":n,t);import{b as $,u as k,v as q,q as x,R as A}from"./index-ucXmJ9nZ.js";import{r as h,R as T}from"./react-vendor-C7qxa2PD.js";import{j as w}from"./index-CM8xp5W3.js";import{u as H}from"./useListenRef-BncaX_Rk.js";import{h as F}from"./antd-DPo7ARJh.js";import{u as N}from"./useEffectOnce-BgFV88FQ.js";import{u as z,h as S}from"./hotkeys.esm-C5d8raBv.js";import"./ahooks-CSAi6c6A.js";function D(e){return e.button==0}function Ce(e){return e.button==2}function G(e){return e.button==1}function U(e){return e&&typeof e=="object"&&!Array.isArray(e)?e:{}}function Ee(e){return typeof e=="object"&&!Array.isArray(e)&&!!e}function X(e){let n;try{n=new Function(`${e} return main;`)()}catch(t){console.error("[bigScreen](getMainFunction)ï¼š",t)}return n}function _(e,n){h.useEffect(()=>{const t=e.current;if(!t)throw new Error("dom must be set.");const s=[];for(const r in n){const a=n[r];t.addEventListener(r,a),s.push(()=>t.removeEventListener(r,a))}return()=>{s.forEach(r=>r())}},[])}function we(){return $(e=>e.componentNodes)}function Z(e){return $(n=>e?e(n.config):n.config)}function xe(e){const n=h.useMemo(()=>e,[]),{engine:t}=k();return h.useEffect(()=>(t.instance.add(n),()=>{t.instance.delete(n.id)}),[]),n}class Q{constructor(n){b(this,"timerId");b(this,"requestConfig");b(this,"callbackList",[]);n&&this.reload(n)}notifyDataSource(n){this.callbackList.forEach(t=>t(n))}reload(n){this.clear();const t=n?this.requestConfig=n:this.requestConfig;t!=null&&t.url&&(t!=null&&t.first&&this.request(),t!=null&&t.loop&&(this.timerId=setInterval(()=>{this.request()},(t==null?void 0:t.loopDelay)||1e3)))}clear(){this.timerId&&(clearInterval(this.timerId),this.timerId=void 0)}async request(n,t,s){const r=t||this.requestConfig;return r!=null&&r.url?q(`${(r==null?void 0:r.url)||""}`,{...s,method:`${(r==null?void 0:r.method)||"get"}`,params:n}).then(a=>(this.notifyDataSource(a),a)):(console.warn("[bigScreen]: request.url not exist."),Promise.resolve(void 0))}unmount(){this.callbackList=[],this.requestConfig=void 0,this.clear()}onChangeDataSource(n){return this.callbackList.push(n),()=>{this.callbackList=this.callbackList.filter(t=>t!==n)}}}function Se(e){const{dataSourceType:n="static"}=e,t=H(n==="static"),s=h.useRef(),[r,a]=h.useState(),o=h.useCallback(()=>{var u;return s.current||(s.current=new Q(e.request),(u=s.current)==null||u.onChangeDataSource(g=>a(g))),s.current},[e.dataSourceType]);h.useEffect(()=>{if(!t.current)return r&&a(void 0),o(),()=>{var u;(u=s==null?void 0:s.current)==null||u.unmount(),s.current=void 0}},[e==null?void 0:e.dataSourceType]);const d=h.useMemo(()=>({reload(){var u,g;t.current||(g=(u=o())==null?void 0:u.reload)==null||g.call(u,e.request)},async request(u,g){var v,y;if(t.current)return;const l=g?{useCache:!1}:void 0;return Promise.resolve((y=(v=o())==null?void 0:v.request)==null?void 0:y.call(v,u,e.request,l))}}),[]);return{dataSource:t.current?e==null?void 0:e.staticDataSource:r==null?void 0:r[0],requestInstance:d}}function L(e,n){return`${e}-${n}`}function O(e,n,t){if(!e)return n;const s=X(e);return s?s(n,t):n}function V(e,n,t){const s=n==null?void 0:n.option;e.componentNode.update(t.id,{show:!!(s!=null&&s.visible)})}function W(e,n,t,s,r){var d,u;const a=n==null?void 0:n.option;let o=(a==null?void 0:a.type)==="json"?a==null?void 0:a.params:r;o=O(a==null?void 0:a.parserFunc,o,{target:t,origin:s,option:a}),o=U(o),(u=(d=e.instance.get(t==null?void 0:t.id))==null?void 0:d.request)==null||u.call(d,o)}function B(e,n,t,s,r){const a=n==null?void 0:n.option;if(a!=null&&a.function){const o=X(a==null?void 0:a.function),d=o==null?void 0:o(t,s,r);e.componentNode.update(t==null?void 0:t.id,d,{cover:!0})}}function J(e,n,t,s,r){const a=n.option;let d=((a==null?void 0:a.type)||"default")==="default"?r:a==null?void 0:a.value;d=O(a==null?void 0:a.parserFunc,d,{target:t,origin:s,option:a}),e.events.notify(L(t.id,n.exposeId),d)}function K(e,n){return function(t,s){var o,d,u;const r=e.componentNode.get(n),a=(u=(d=(o=r==null?void 0:r.events)==null?void 0:o.find)==null?void 0:d.call(o,g=>(g==null?void 0:g.triggerId)===t))==null?void 0:u.targets;a&&a.forEach(g=>{const l=e.componentNode.get(g.id);if(!l){F.error("[bigScreen]: target componentNode not exist.");return}g.opts.forEach(v=>{switch(v.exposeId){case x.visible:V(e,v,l);break;case x.request:W(e,v,l,r,s);break;case x.custom:B(e,v,l,r,s);break;default:J(e,v,l,r,s);break}})})}}function Me(e){const{engine:n}=k();return h.useMemo(()=>K(n,e),[])}function p(e,n){return function(t){h.useEffect(()=>{for(const s in t)e.events.on(L(n,s),t[s]);return()=>{for(const s in t)e.events.remove(L(n,s),t[s])}},[])}}function Ie(e){const{engine:n}=k();return h.useMemo(()=>p(n,e),[])}function Pe(){const[e,n]=h.useState([]),{engine:t}=k();return N(()=>(n(t.component.getAllPackage()),t.component.onPackageChange(s=>{n(s)}))),e}function ee(){const{engine:e}=k(),n=z(),[t,s]=h.useState(r);function r(){return e.page.get(e.config.getCurrentPage())}return h.useEffect(()=>e.page.onChange(()=>{const a=r();s(a?{...a}:void 0)}),[]),h.useEffect(()=>{s(r)},[n]),t}function te(){const e=A.getActiveEngine();if(!e)return;const n=e.config.getConfig();e.config.setConfig({scale:n.scaleDefault,editorOffsetX:0,editorOffsetY:0})}const ne="global-cursor",M="global-cursor";class se{constructor(){b(this,"style");b(this,"isSet",!1)}set(n){const t=document.createElement("style");t.setAttribute("id",ne),t.innerHTML=`html.${M} * {cursor:${n} !important;}`,document.head.appendChild(t),document.documentElement.classList.add(M),this.isSet=!0,this.style=t}revoke(){var n,t;this.isSet&&(this.isSet=!1,document.documentElement.classList.remove(M),this.style&&((t=(n=this.style)==null?void 0:n.remove)==null||t.call(n),this.style=void 0))}}const E=new se;function re(e,n,t){return e<n?n:e>t?t:e}function ae(e){let n=1,t=0;if(e.wheelDeltaY){const s=e.wheelDeltaY;n=Math.abs(s)/120,t=s>0?1:s<0?-1:0}else if(e.deltaY){const s=e.deltaY;n=Math.floor(Math.max(Math.abs(s)-4,0)/40)||1,t=s>0?1:s<0?-1:0}return{times:n,direction:t}}const ie="_infiniteCanvas_1ilxa_59",ce="_infiniteCanvas_inner_1ilxa_66",ue="_infiniteCanvas_mask_1ilxa_74",I={infiniteCanvas:ie,infiniteCanvas_inner:ce,infiniteCanvas_mask:ue};function fe(e){var C;const n=(e==null?void 0:e.scale)||1;let t={startX:(e==null?void 0:e.startX)??0,startY:(e==null?void 0:e.startY)??0};const{startHooks:s=[],moveHooks:r=[],endHooks:a=[]}=((C=e==null?void 0:e.hookQueue)==null?void 0:C.reduce((m,i)=>(i&&(i!=null&&i.onStart&&m.startHooks.push(i.onStart),i!=null&&i.onMove&&m.moveHooks.push(i.onMove),i!=null&&i.onEnd&&m.endHooks.push(i.onEnd)),m),{startHooks:[],moveHooks:[],endHooks:[]}))||{};e!=null&&e.onStart&&s.push(e.onStart),e!=null&&e.onMove&&r.push(e.onMove),e!=null&&e.onEnd&&a.push(e.onEnd);const o=s.length||r.length||a.length;function d(m=0,i=0,c){let f=0;for(;s[f]&&s[f](m,i,c)!==!1;)f++}function u(m,i,c){let f=0;for(;r[f]&&r[f](m,i,c)!==!1;)f++}function g(m,i,c){let f=0;for(;a[f]&&a[f](m,i,c)!==!1;)f++}function l(m){const i=m.x-t.startX,c=m.y-t.startY;u(i/n,c/n,m)}function v(m){const i=Math.round((m.x-t.startX)/n),c=Math.round((m.y-t.startY)/n);g(i,c,m),y()}function y(){o&&(window.removeEventListener("mouseup",v),window.removeEventListener("mousemove",l))}return o&&(window.addEventListener("mouseup",v),window.addEventListener("mousemove",l),d(0,0,e==null?void 0:e.startEvent)),()=>y()}function P(e){return typeof e=="number"}function oe(e){const{engine:n}=k(),{defaultScale:t=1,scaleStep:s=.05,scaleMax:r=2,scaleMin:a=.1}=e,o=h.useRef(null),d=h.useRef(null),u=h.useRef(null),g=H(e),l=h.useRef({scale:t,x:0,y:0});function v(){var i;(i=e==null?void 0:e.onChange)==null||i.call(e,l.current.scale,l.current.x,l.current.y)}function y(i){const c=d.current;c.style.transform=`scale(${i})`,c.style.transformOrigin="top left"}function C(i,c){const f=d.current;f.style.transform=`translate(${i}px, ${c}px) scale(${l.current.scale})`,f.style.transformOrigin="top left"}function m(i,c){d.current.style.top=`${c}px`,d.current.style.left=`${i}px`}return _(o,{mousedown(i){var c,f;G(i)&&((f=(c=g.current)==null?void 0:c.onReset)==null||f.call(c)),D(i)&&S.isPressed("space")&&E.set("grabbing")},mouseup(i){if(D(i)){if(S.isPressed("space")){E.set("grab");return}E.revoke()}},wheel(i){const c=ae(i),f=c.times*s*c.direction;l.current.scale=re(l.current.scale+f,a,r),y(l.current.scale),v()}}),_(u,{mousedown(i){fe({startEvent:i,startX:i.x,startY:i.y,onStart(c,f){C(c,f)},onMove(c,f){C(c,f)},onEnd(c,f){y(l.current.scale),m(l.current.x+=c,l.current.y+=f),v()}})}}),h.useEffect(()=>{let i=!1;f();function c(){i=!0,u.current.style.removeProperty("pointer-events"),u.current.style.zIndex=`${n.componentNode.getMaxLevel()}`,E.set("grab")}function f(){i=!1,u.current.style.pointerEvents="none",E.revoke()}S("space",{keyup:!0},Y=>{Y.type==="keydown"&&!i&&c(),Y.type==="keyup"&&f()})},[]),h.useEffect(()=>{P(e.scale)&&l.current.scale!==e.scale&&y(l.current.scale=e.scale)},[e.scale]),h.useEffect(()=>{P(e.offsetX)&&P(e.offsetY)&&(e.offsetX!==l.current.x||e.offsetY!==l.current.y)&&m(l.current.x=e.offsetX,l.current.y=e.offsetY)},[e.offsetX,e.offsetY]),w.jsxs("div",{className:I.infiniteCanvas,ref:o,style:e==null?void 0:e.style,children:[w.jsx("div",{className:I.infiniteCanvas_inner,ref:d,children:e==null?void 0:e.children}),w.jsx("div",{className:I.infiniteCanvas_mask,ref:u})]})}const Le=T.forwardRef((e,n)=>{const{options:t}=ee()||{},{engine:s}=k(),r=Z(),a=w.jsx("div",{ref:n,className:e==null?void 0:e.className,style:{background:t==null?void 0:t.background,border:t!=null&&t.bordered?`1px solid ${t.borderColor}`:void 0,width:r.width,height:r.height,...e==null?void 0:e.style},children:e==null?void 0:e.children});return e!=null&&e.preview?a:w.jsx(oe,{style:{width:"100%",height:"100%"},scale:r.scale,defaultScale:r.scaleDefault,scaleStep:r.scaleStep,offsetX:r.editorOffsetX,offsetY:r.editorOffsetY,scaleMax:r.scaleMaxZoom,scaleMin:r.scaleMinZoom,onChange:(o,d,u)=>{s.config.setConfig({scale:o,editorOffsetX:d,editorOffsetY:u})},onReset:()=>{te()},children:a})});export{Le as P,_ as a,we as b,Pe as c,Se as d,Me as e,Ie as f,E as g,xe as h,D as i,Ce as j,Ee as k,ee as l,fe as s,Z as u};
